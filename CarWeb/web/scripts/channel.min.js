var _TREE_NODE_PREFIX="_CHANNEL_";var _AUDIT_FREE_FUNC="switch_channel_audit_flag";var _ADD_CHILD_NODE_FUNC="add_child_channel";var _EDIT_NODE_FUNC="edit_channel";var _REMOVE_NODE_FUNC="remove_channel";var _AUTO_GENERATE_START_ID=-100;var _DEFAULT_AUDIT_FLAG=0;function channelChildrenInArray(b,d){if(b&&d){if(in_array(b.id,d)){return true}if(b.children&&b.children.length>0){for(var a=0;a<b.children.length;a++){var c=channelChildrenInArray(b.children[a],d);if(c){return true}}}}return false}function Channel(d,b,a,c){this.id=d;this.name=b;this.auditFlag=a;this.selected=c;this.children=[]}function ChannelUtils(){this.autoChannelId=_AUTO_GENERATE_START_ID;this.selectAllMark=0;this.openToSelected=true;this.grantedChannel=[];this.grantEnabled=false;this.setGrantEnabled=function(g){this.grantEnabled=g};this.channelList=[];this.selectedChannel=[];this.initByJson=function(json){var channelJson=eval("(function(){return "+json+";})()");function parseChildNode(n,p,a,mark){if(n){if(n.children){for(var i=0;i<n.children.length;i++){var cn=n.children[i];if(cn){var selected=in_array(cn.id,a);switch(mark){case 1:selected=true;break;case 2:selected=false;break;default:}var ch=new Channel(cn.id,cn.name,cn.auditFlag,selected);if(cn.children&&cn.children.length>0){parseChildNode(cn,ch,a,mark)}if(p){p.children.push(ch)}}}}}}for(var n=0;n<channelJson.length;n++){var cn=channelJson[n];if(cn){var selected=in_array(cn.id,this.selectedChannel);switch(this.selectAllMark){case 1:selected=true;break;case 2:selected=false;break;default:}var ch=new Channel(cn.id,cn.name,cn.auditFlag,selected);if(cn.children&&cn.children.length>0){parseChildNode(cn,ch,this.selectedChannel,this.selectAllMark)}this.channelList.push(ch)}}};this.getAllChildrenNode=function(){if(this.channelList.length==0){return null}var _a=[];var parseChildren=function(node,array){if(node&&node.children){for(var i=0;i<node.children.length;i++){var n=node.children[i];if(n.children&&n.children.length>0){parseChildren(n,array)}else{array.push(n)}}}};for(var i=0;i<this.channelList.length;i++){var n=this.channelList[i];if(n.children&&n.children.length>0){parseChildren(n,_a)}else{_a.push(n)}}return _a};this.setSelectedChannel=function(channelString){this.selectedChannel=(""+channelString).split(",")};this.generateTreeData=function(){var chList=(arguments.length>0)?arguments[0]:this.channelList;if(chList.length==0){return null}var hasGrantedInChildren=function(c,a){if(c){if(in_array(c.id,a)){return true}for(var i=0;i<c.children.length;i++){var m=hasGrantedInChildren(c.children[i],a);if(m){return true}}return false}else{return false}};var tree_data={};var buildChildren=function(ch,prop,a,mark,useGrant,granted,openToSelected){for(var i=0;i<ch.children.length;i++){var c_ch=ch.children[i];if(useGrant&&!hasGrantedInChildren(c_ch,granted)){continue}var ch_type=(c_ch.children&&c_ch.children.length>0)?"folder":"item";prop[_TREE_NODE_PREFIX+c_ch.id]={name:c_ch.name,type:ch_type,id:c_ch.id};var selected=channelChildrenInArray(c_ch,a);switch(mark){case 1:selected=true;break;case 2:selected=false;break;default:}if(ch_type=="item"&&selected){prop[_TREE_NODE_PREFIX+c_ch.id]["additionalParameters"]={"item-selected":true}}else{if(ch_type=="folder"){if(openToSelected&&selected){prop[_TREE_NODE_PREFIX+c_ch.id]["additionalParameters"]={"item-opened":true}}else{prop[_TREE_NODE_PREFIX+c_ch.id]["additionalParameters"]={}}prop[_TREE_NODE_PREFIX+c_ch.id]["additionalParameters"]["children"]={};buildChildren(c_ch,prop[_TREE_NODE_PREFIX+c_ch.id]["additionalParameters"]["children"],a,mark,useGrant,granted,openToSelected)}}}};for(var i=0;i<chList.length;i++){var ch=chList[i];if(this.grantEnabled&&!hasGrantedInChildren(ch,this.grantedChannel)){continue}var ch_type=(ch.children&&ch.children.length>0)?"folder":"item";tree_data[_TREE_NODE_PREFIX+ch.id]={name:ch.name,type:ch_type,id:ch.id};var selected=channelChildrenInArray(ch,this.selectedChannel);switch(this.selectAllMark){case 1:selected=true;break;case 2:selected=false;break;default:}if(ch_type=="item"&&selected){tree_data[_TREE_NODE_PREFIX+ch.id]["additionalParameters"]={"item-selected":true}}else{if(ch_type=="folder"){if(this.openToSelected&&selected){tree_data[_TREE_NODE_PREFIX+ch.id]["additionalParameters"]={"item-opened":true}}else{tree_data[_TREE_NODE_PREFIX+ch.id]["additionalParameters"]={}}tree_data[_TREE_NODE_PREFIX+ch.id]["additionalParameters"]["children"]={};buildChildren(ch,tree_data[_TREE_NODE_PREFIX+ch.id]["additionalParameters"]["children"],this.selectedChannel,this.selectAllMark,this.grantEnabled,this.grantedChannel,this.openToSelected)}}}return new DataSourceTree({data:tree_data})};this.generateFilterTree=function(){if(this.channelList.length<=1){return this.generateTreeData()}var super_channelList=[];var superChannel=new Channel(-1,"所有栏目",0,false);for(var i=0;i<this.channelList.length;i++){superChannel.children.push(this.channelList[i])}super_channelList.push(superChannel);return this.generateTreeData(super_channelList)};this.generateNestableData=function(){var nestableChildren=function(ch){if(ch&&ch.children&&ch.children.length>0){output+='<ol class="bb-list">';for(var j=0;j<ch.children.length;j++){var child=ch.children[j];if(child){output+='<li class="bb-item" data-id="'+child.id+'" data-name="'+encodeURI(child.name)+'" data-flag="'+child.auditFlag+'">';output+='<div class="bb-handle"><span>'+child.name+'</span><div class="pull-right action-buttons">';if(parseInt(child.auditFlag)==1){output+='<a class="blue" href="#" style="margin-right: 40px" title="取消频道免审" onclick="'+_AUDIT_FREE_FUNC+"("+child.id+');return false;"><i class="ace-icon fa fa-flag bigger-130"></i></a>'}else{output+='<a class="green" href="#" style="margin-right: 40px" title="设置频道免审" onclick="'+_AUDIT_FREE_FUNC+"("+child.id+');return false;"><i class="ace-icon fa fa-flag-o bigger-130"></i></a>'}output+='<a class="green" href="#" title="添加子频道" onclick="'+_ADD_CHILD_NODE_FUNC+"("+child.id+');return false;"><i class="ace-icon fa fa-plus bigger-130"></i></a><a class="blue" href="#" title="编辑频道" onclick="'+_EDIT_NODE_FUNC+"("+child.id+');return false;"><i class="ace-icon fa fa-pencil bigger-130"></i></a><a class="red" href="#" title="删除频道" onclick="'+_REMOVE_NODE_FUNC+"("+child.id+');return false;"><i class="ace-icon fa fa-trash-o bigger-130"></i> </a></div>';output+="</div>";if(child.children&&child.children.length>0){nestableChildren(child)}output+="</li>"}}output+="</ol>"}};var output='<ol class="bb-list">';for(var i=0;i<this.channelList.length;i++){var ch=this.channelList[i];if(ch){output+='<li class="bb-item" data-id="'+ch.id+'" data-name="'+encodeURI(ch.name)+'" data-flag="'+ch.auditFlag+'">';output+='<div class="bb-handle"><span>'+ch.name+'</span><div class="pull-right action-buttons">';if(parseInt(ch.auditFlag)==1){output+='<a class="blue" href="#" style="margin-right: 40px" title="取消频道免审" onclick="'+_AUDIT_FREE_FUNC+"("+ch.id+');return false;"><i class="ace-icon fa fa-flag bigger-130"></i></a>'}else{output+='<a class="green" href="#" style="margin-right: 40px" title="设置频道免审" onclick="'+_AUDIT_FREE_FUNC+"("+ch.id+');return false;"><i class="ace-icon fa fa-flag-o bigger-130"></i></a>'}output+='<a class="green" href="#" title="添加子频道" onclick="'+_ADD_CHILD_NODE_FUNC+"("+ch.id+')"><i class="ace-icon fa fa-plus bigger-130"></i></a><a class="blue" href="#" title="编辑频道" onclick="'+_EDIT_NODE_FUNC+"("+ch.id+');return false;"><i class="ace-icon fa fa-pencil bigger-130"></i></a><a class="red" href="#" title="删除频道" onclick="'+_REMOVE_NODE_FUNC+"("+ch.id+');return false;"><i class="ace-icon fa fa-trash-o bigger-130"></i> </a></div>';output+="</div>";if(ch.children&&ch.children.length>0){nestableChildren(ch)}output+="</li>"}}output+="</ol>";return output};this.generateNewChannel=function(pid,name){var output='<li class="bb-item" data-id="'+this.autoChannelId+'"  data-name="'+encodeURI(name)+'" data-flag="'+_DEFAULT_AUDIT_FLAG+'"><div class="bb-handle"><span>'+name+'</span><div class="pull-right action-buttons">';if(parseInt(_DEFAULT_AUDIT_FLAG)==1){output+='<a class="blue" href="#" style="margin-right: 40px" title="取消频道免审" onclick="'+_AUDIT_FREE_FUNC+"("+this.autoChannelId+');return false;"><i class="ace-icon fa fa-flag bigger-130"></i></a>'}else{output+='<a class="green" href="#" style="margin-right: 40px" title="设置频道免审" onclick="'+_AUDIT_FREE_FUNC+"("+this.autoChannelId+');return false;"><i class="ace-icon fa fa-flag-o bigger-130"></i></a>'}output+='<a class="green" href="#" title="添加子频道" onclick="'+_ADD_CHILD_NODE_FUNC+"("+this.autoChannelId+');return false;"><i class="ace-icon fa fa-plus bigger-130"></i></a><a class="blue" href="#" title="编辑频道" onclick="'+_EDIT_NODE_FUNC+"("+this.autoChannelId+');return false;"><i class="ace-icon fa fa-pencil bigger-130"></i></a><a class="red" href="#" title="删除频道" onclick="'+_REMOVE_NODE_FUNC+"("+this.autoChannelId+');return false;"><i class="ace-icon fa fa-trash-o bigger-130"></i> </a></div>';output+="</div></li>";this.autoChannelId--;return output};this.addChild=function(pid,title){var parentChannel=this.findChannel(pid);if(!parentChannel){return null}var channel=new Channel(this.autoChannelId,title,_DEFAULT_AUDIT_FLAG,false);parentChannel.children.push(channel);return channel};this.findChannel=function(id){var iterateChild=function(channel,id){if(!channel){return null}if(channel.children&&channel.children.length>0){for(var i=0;i<channel.children.length;i++){var c=channel.children[i];if(!c){continue}if(c.id==id){return c}else{if(c.children&&c.children.length>0){var cc=iterateChild(c,id);if(cc){return cc}}}}}return null};for(var i=0;i<this.channelList.length;i++){var channel=this.channelList[i];if(channel){if(channel.id==id){return channel}else{if(channel.children&&channel.children.length>0){var cc=iterateChild(channel,id);if(cc){return cc}}}}}return null};this.getFirstLevelChannel=function(){var firstLvChannelList=[];if(this.channelList){return(this.channelList.length>1)?this.channelList:this.channelList[0].children}};this.setGrantChannel=function(s){this.grantedChannel=(""+s).split(",")}};